name: 每日更新爱快省份IP分组

# 触发条件：每天定时运行（北京时间02:00）+ 手动触发
on:
  schedule:
    # Cron表达式（UTC时间18:00对应北京时间02:00）
    - cron: '0 18 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  update-province-ipgroup:
    runs-on: ubuntu-latest
    steps:
      ##########################################################################
      # 步骤1：拉取仓库代码（确保获取最新版本）
      ##########################################################################
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史，避免浅克隆问题

      ##########################################################################
      # 步骤2：配置Python环境（脚本依赖Python 3.x）
      ##########################################################################
      - name: 配置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # 与脚本兼容的版本

      ##########################################################################
      # 步骤3：安装脚本依赖（requests库用于网络请求）
      ##########################################################################
      - name: 安装依赖库
        run: |
          python -m pip install --upgrade pip
          pip install requests  # 脚本中用于拉取IP数据

      ##########################################################################
      # 步骤4：运行脚本生成省份IP分组文件
      ##########################################################################
      - name: 执行生成脚本
        run: |
          echo "=== 开始运行ikai_cni_p.py生成文件 ==="
          python "ikai_cni_p.py"  # 执行目标脚本
          
          # 验证文件是否生成成功
          if [ ! -f "ikuai_cn_province_ipgroup.txt" ]; then
            echo "ERROR: 未生成目标文件ikuai_cn_province_ipgroup.txt！"
            ls -l  # 列出现有文件便于排查
            exit 1
          fi
          
          echo "=== 生成的文件信息 ==="
          ls -l ikuai_cn_province_ipgroup.txt  # 确认文件存在

      ##########################################################################
      # 步骤5：提交更新后的文件到仓库
      ##########################################################################
      - name: 提交并推送更新
        run: |
          # 配置Git提交身份
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # 暂存本地修改（解决pull冲突）
          git stash
          
          # 拉取最新代码避免冲突
          git pull origin main --rebase
          
          # 恢复暂存的修改
          git stash pop || true  # 无暂存内容时不报错
          
          # 添加目标文件
          git add ./ikuai_cn_province_ipgroup.txt
          
          # 检查暂存区状态
          echo "=== 暂存区状态 ==="
          git status
          
          # 仅在有修改时提交
          if git diff --cached --quiet; then
            echo "=== 无文件修改，无需提交 ==="
          else
            git commit -m "每日自动更新省份IP分组（生成时间：${{ github.run_started_at }}）"
            git push origin main  # 推送至main分支
            echo "=== 文件提交成功 ==="
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 自动注入的授权Token

      ##########################################################################
      # 步骤6：清理旧工作流记录（保留最近5条，避免日志堆积）
      ##########################################################################
      - name: 清理旧工作流记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          keep_minimum_runs: 5
          workflow_id: "每日更新爱快省份IP分组"  # 需与工作流名称一致
